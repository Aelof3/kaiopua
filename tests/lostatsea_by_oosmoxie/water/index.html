<!DOCTYPE HTML>
<html lang="en">
    <head>
        <title>Lost at sea</title>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="../css/style.css">
    </head>
    
    <body>
        <div id="infobutton">
            <a href="javascript:toggleInfo()"><img src="../general/i.png" border="0"></a>
        </div>
        <div id="info">
                <B>Lost at sea - WebGL(html5)</B><BR>
                <P>Trying to do some water/ocean. Thanks to <a href="http://alteredqualia.com/" target="_blank">AlteredQualia</a> for __dirtyVertices.<BR>Also discovered cubemaps/skyboxes. ;)</P>
                Done using <a href="https://github.com/mrdoob/three.js" target="_blank">three.js</a>.
                <P><B>Note.</B> You need a modern browser that supports WebGL for this to run the way it is intended.<BR>
                For example. <a href="http://www.google.com/landing/chrome/beta/" target="_blank">Google Chrome 9+</a> or <a href="http://www.mozilla.com/firefox/beta/" target="_blank">Firefox 4+</a>.</P>
                <font color="#777777">(C) OutsideOfSociety 2011.
        </div>
        
        <script type="text/javascript" src="../build/ThreeExtras.js"></script>

        <script type="text/javascript" src="../general/RequestAnimationFrame.js"></script>
        <script type="text/javascript" src="../general/Stats.js"></script>
        <script type="text/javascript" src="../general/info.js"></script>


        <script type="text/javascript">

            var SCREEN_WIDTH = window.innerWidth;
            var SCREEN_HEIGHT = window.innerHeight;
            var FLOOR = 0;

            var container;
            var stats;

            var camera;
            var scene;
            var webglRenderer;

            var directionalLight, pointLight;

            var windowHalfX = window.innerWidth >> 1;
            var windowHalfY = window.innerHeight >> 1;

            var render_gl = 1;
            var has_gl = 0;
            
            var r = 0;
            var w = 0;
            
            var cubeMesh;
            var textureCube;

            var water;
            var waterMesh;

            init(), animate();
                
            
                
            

            function addMesh( geometry, scale, x, y, z, rx, ry, rz, material ) {
                
                mesh = new THREE.Mesh( geometry, material );
                mesh.scale.x = mesh.scale.y = mesh.scale.z = scale;
                mesh.position.x = x;
                mesh.position.y = y;
                mesh.position.z = z;
                mesh.rotation.x = rx;
                mesh.rotation.y = ry;
                mesh.rotation.z = rz;
                mesh.overdraw = true;
                mesh.doubleSided = false;
                mesh.updateMatrix();
                scene.addObject(mesh);

                return mesh;
            }
                
            function changeAnim(label) {
                if (label == "stop") {
                    md.stop();
                    mdw.stop();
                    return;
                }
                md.gotoAndPlay(label, true);
                mdw.gotoAndPlay(label, true);
            }
                

            function init() {

                container = document.createElement('div');
                document.body.appendChild(container);
                
                var aspect = SCREEN_WIDTH / SCREEN_HEIGHT;

                camera = new THREE.Camera( 75, aspect, 1, 100000 );
                camera.position.z = 650;
                camera.position.x = 0;
                camera.position.y = FLOOR+2000;

                scene = new THREE.Scene();

                scene.fog = new THREE.Fog( 0x3d4456, 0, 70000 );

                // LIGHTS
                var ambient = new THREE.AmbientLight( 0xffffff );
                scene.addLight( ambient );

                var path = "../textures/cube/sky/";
                var format = '.jpg';
                var urls = [
                        path + 'px' + format, path + 'nx' + format,
                        path + 'py' + format, path + 'ny' + format,
                        path + 'pz' + format, path + 'nz' + format
                    ];


                var images = ImageUtils.loadArray( urls );
                textureCube = new THREE.Texture( images );

                SceneUtils.addPanoramaCubeWebGL( scene, 100000, textureCube );

                var cube = new Cube( 1, 1, 1, 1, 1 );
                cubeMesh = addMesh( cube, 1,  0, FLOOR, 0, 0,0,0, new THREE.MeshLambertMaterial( { color: 0xFF3333 } ) );
                cubeMesh.visible = false;
                camera.target = cubeMesh;
                
                water = new Plane( 100, 100, 50, 50 );
                
                for(var i=0; i<water.uvs.length; i++) {
                    var uvs = water.uvs[i];
                    for ( j = 0, jl = uvs.length; j < jl; j++ ) {
                        uvs[j].u *= 50;
                        uvs[j].v *= 50;
                    }
                }
                waterMesh = addMesh( water, 1000,  0, FLOOR, 0, -1.57,0,0, getWaterMaterial() );

                try {
                    webglRenderer = new THREE.WebGLRenderer( { scene: scene, clearColor: 0x3d4456, clearAlpha: 0.5 } );
                    webglRenderer.setFaceCulling(0);
                    webglRenderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
                    container.appendChild( webglRenderer.domElement );
                    has_gl = 1;
                }
                catch (e) {
                    // need webgl
                    document.getElementById('info').innerHTML = "<P><BR><B>Note.</B> You need a modern browser that supports WebGL for this to run the way it is intended.<BR>For example. <a href='http://www.google.com/landing/chrome/beta/' target='_blank'>Google Chrome 9+</a> or <a href='http://www.mozilla.com/firefox/beta/' target='_blank'>Firefox 4+</a>.</P><CENTER><BR><img src='../general/WebGL_logo.png' border='0'></CENTER>";
                    document.getElementById('info').style.display = "block";
                    return;
                }

                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                stats.domElement.style.zIndex = 100;
                container.appendChild( stats.domElement );
                
            }

            function getWaterMaterial () {
                var waterMaterial = new THREE.MeshBasicMaterial( { map: new THREE.Texture(null, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping), env_map: textureCube, combine: THREE.Mix, reflectivity: 0.5 , opacity: 0.95, shininess: 0.5, shading: THREE.FlatShading } );

                var img = new Image();
                waterMaterial.map.image = img;
                img.onload = function () {
                    waterMaterial.map.image.loaded = 1;
                };
                img.src = "water.jpg";

                return waterMaterial;
            }

            function wave() {
                for ( var x = 0; x < 50; ++x ) {
                    var divider = 4;
                    for ( var z = 0; z < 50; ++z ) {
                        water.vertices[ x + z * 50 ].position.z = Math.cos( x+w )/divider + Math.sin( z+w )/divider;
                    }
                }

                water.__dirtyVertices = true;
            }

            function animate() {
                requestAnimationFrame( animate );
                loop();
            }

            function loop() {
                var dist = 3000;

                camera.position.x = dist*Math.cos(r);
                camera.position.z = dist*Math.sin(r);
                
                cubeMesh.position.y = FLOOR + 1500 - (Math.sin(r*5)*800);
                camera.position.y = FLOOR + 1100 - (Math.sin(r*5)*400)

                r += 0.005;
                w += 0.04;

                wave();

                if ( render_gl && has_gl ) {
                    webglRenderer.render( scene, camera );
                }
                stats.update();

            }


        </script>

    </body>
</html>
